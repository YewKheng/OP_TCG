name: Daily Scrape

on:
  schedule:
    # Runs daily at 6 AM Malaysia Time (MYT, UTC+8)
    # 6 AM MYT = 22:00 UTC previous day (10 PM UTC)
    # To adjust for other timezones:
    # - 3 AM JST (Japan) = 18:00 UTC previous day ‚Üí use: '0 18 * * *'
    # - 3 AM EST (US East) = 8:00 UTC ‚Üí use: '0 8 * * *'
    # - 3 AM PST (US West) = 11:00 UTC ‚Üí use: '0 11 * * *'
    - cron: "0 22 * * *" # 6 AM MYT = 10 PM UTC previous day
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 180 # Allow up to 3 hours for scraping all terms
    permissions:
      contents: write # Required to push changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Fetch all history for proper git operations

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run scrape
        id: scrape
        run: npm run scrape:all
        continue-on-error: true # Continue even if some searches fail

      - name: Check for changes and commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if data file exists and has changes
          if [ -f "data/scraped-data.json" ]; then
            echo "üìä Checking for changes in data/scraped-data.json..."
            git add data/scraped-data.json
            
            # Show what changed (for debugging)
            echo "üìù Staged changes:"
            git diff --staged --stat || echo "No staged changes"
            
            # Check if there are any changes to commit
            if git diff --staged --quiet; then
              echo "‚ö†Ô∏è No changes detected in data/scraped-data.json"
              echo "This might mean:"
              echo "  - All search terms already have the latest data"
              echo "  - Scrape completed but data is identical"
            else
              echo "‚úÖ Changes detected, committing..."
              COMMIT_MSG="Auto-update scraped data - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
              git commit -m "$COMMIT_MSG"
              git push origin HEAD:${{ github.ref_name }}
              echo "‚úÖ Changes committed and pushed successfully"
              echo "üì¶ Commit message: $COMMIT_MSG"
            fi
          else
            echo "‚ö†Ô∏è data/scraped-data.json not found, skipping commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
